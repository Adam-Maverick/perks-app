<story-context id="1-4-invitation-code-registration-fallback.context" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.4</storyId>
    <title>Invitation Code Registration (Fallback)</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-22</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-invitation-code-registration-fallback.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>employee at a company without SSO</asA>
    <iWant>register using a unique invitation code</iWant>
    <soThat>I can still access the platform</soThat>
    <tasks>
- Create `invitations` table schema (AC: 1)
- Implement Invitation Validation Logic (AC: 1)
- Update Signup Flow (AC: 2, 3)
- Implement Post-Signup Actions (AC: 4, 5, 6)
- Testing &amp; Verification
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Given** my employer does not have SSO configured
   **When** I visit the registration page and enter my invitation code
   **Then** the system validates the code against the `invitations` table
2. **And** I can create an account with email/password
3. **And** My account is linked to the correct employer organization
4. **And** The invitation code is marked as "used" and cannot be reused
5. **And** I receive a welcome email with next steps
6. **And** I am redirected to the employee dashboard
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>MVP - Minimum Viable Product (Phase 1: Months 1-6)</section>
        <snippet>FR1: Employees can create accounts via Employer SSO or unique invitation code.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.4: Invitation Code Registration (Fallback)</section>
        <snippet>As an employee at a company without SSO, I want to register using a unique invitation code, So that I can still access the platform.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Data Architecture</section>
        <snippet>Key Models: User, Organization, Wallet, Transaction, Deal, EscrowHold.</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>src/db/schema.ts</path>
        <kind>schema</kind>
        <symbol>invitations</symbol>
        <lines>new</lines>
        <reason>Need to add invitations table definition here.</reason>
      </item>
      <item>
        <path>src/app/(auth)/sign-up/[[...sign-up]]/page.tsx</path>
        <kind>component</kind>
        <symbol>Page</symbol>
        <lines>1-60</lines>
        <reason>Modify to include invitation code input and validation logic.</reason>
      </item>
      <item>
        <path>src/middleware.ts</path>
        <kind>config</kind>
        <symbol>clerkMiddleware</symbol>
        <lines>1-19</lines>
        <reason>Ensure dashboard routes remain protected.</reason>
      </item>
    </code>
    <dependencies>
      <dep>@clerk/nextjs</dep>
      <dep>drizzle-orm</dep>
      <dep>react</dep>
      <dep>zod</dep>
      <dep>resend</dep>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>All data mutations (creates, updates, deletes) MUST use Next.js Server Actions.</constraint>
    <constraint>Use Zod to validate all inputs.</constraint>
    <constraint>Return a standardized ActionResponse type { success: boolean, data?: T, error?: string }.</constraint>
    <constraint>Use auth() helper in Server Components to get user context.</constraint>
    <constraint>Rate limiting required for invitation code validation (max 5 attempts per IP per hour).</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>validateInvitationCode</name>
      <kind>Server Action</kind>
      <signature>validateInvitationCode(code: string): Promise&lt;ActionResponse&lt;Invitation&gt;&gt;</signature>
      <path>src/server/actions/invitations.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Manual testing required for the registration flow. Unit tests for the validation logic.
    </standards>
    <locations>
      <loc>src/server/actions/invitations.test.ts</loc>
    </locations>
    <ideas>
      <idea>Test with valid unused code (should succeed)</idea>
      <idea>Test with invalid code (should fail)</idea>
      <idea>Test with used code (should fail)</idea>
      <idea>Test rate limiting (6th attempt should fail)</idea>
      <idea>Verify organization linking in DB after signup</idea>
    </ideas>
  </tests>
</story-context>
